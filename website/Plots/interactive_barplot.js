const startYear = 1973,
  endYear = 2022,
  btn = document.getElementById('play-pause-button'),
  input = document.getElementById('play-range'),
  nbr = 20;

let dataset, chart;


/*
 * Animate dataLabels functionality
 */
(function (H) {
  const FLOAT = /^-?\d+\.?\d*$/;

  // Add animated textSetter, just like fill/strokeSetters
  H.Fx.prototype.textSetter = function () {
    let startValue = this.start.replace(/ /g, ''),
      endValue = this.end.replace(/ /g, ''),
      currentValue = this.end.replace(/ /g, '');

    if ((startValue || '').match(FLOAT)) {
      startValue = parseInt(startValue, 10);
      endValue = parseInt(endValue, 10);

      // No support for float
      currentValue = Highcharts.numberFormat(
        Math.round(startValue + (endValue - startValue) * this.pos),
        0
      );
    }

    this.elem.endText = this.end;

    this.elem.attr(this.prop, currentValue, null, true);
  };

  // Add textGetter, not supported at all at this moment:
  H.SVGElement.prototype.textGetter = function () {
    const ct = this.text.element.textContent || '';
    return this.endText ? this.endText : ct.substring(0, ct.length / 2);
  };

  // Temporary change label.attr() with label.animate():
  // In core it's simple change attr(...) => animate(...) for text prop
  H.wrap(H.Series.prototype, 'drawDataLabels', function (proceed) {
    const attr = H.SVGElement.prototype.attr,
      chart = this.chart;

    if (chart.sequenceTimer) {
      this.points.forEach(point =>
        (point.dataLabels || []).forEach(
          label =>
            (label.attr = function (hash) {
              if (hash && hash.text !== undefined) {
                const text = hash.text;

                delete hash.text;

                return this
                  .attr(hash)
                  .animate({ text });
              }
              return attr.apply(this, arguments);

            })
        )
      );
    }

    const ret = proceed.apply(
      this,
      Array.prototype.slice.call(arguments, 1)
    );

    this.points.forEach(p =>
      (p.dataLabels || []).forEach(d => (d.attr = attr))
    );

    return ret;
  });
}(Highcharts));


function getData(year) {
  const output = Object.entries(dataset)
    .map(country => {
      const [countryName, countryData] = country;
      return [countryName, Number(countryData[year])];
    })
    .sort((a, b) => b[1] - a[1]);
  return [output[0], output.slice(1, nbr)];
}

function getSubtitle() {
  const population = (getData(input.value)[0][1] ).toFixed(2);
  return `<span style="font-size: 80px">${input.value}</span>
    <br>
`;
}

(async () => {

  // dataset = await fetch(
  //   'https://demo-live-data.highcharts.com/population.json'
  // ).then(response => response.json());
  
  dataset = {"Light": {"1973": 26, "1974": 34, "1975": 47, "1976": 41, "1977": 32, "1978": 43, "1979": 35, "1980": 38, "1981": 24, "1982": 29, "1983": 12, "1984": 20, "1985": 1, "1986": 15, "1987": 39, "1988": 30, "1989": 27, "1990": 40, "1991": 41, "1992": 39, "1993": 46, "1994": 58, "1995": 2, "1996": 6, "1997": 43, "1998": 6, "1999": 539, "2000": 551, "2001": 638, "2002": 609, "2003": 722, "2004": 853, "2005": 852, "2006": 706, "2007": 917, "2008": 996, "2009": 1072, "2010": 941, "2011": 1130, "2012": 1538, "2013": 1517, "2014": 1733, "2015": 1458, "2016": 1133, "2017": 1046, "2018": 682, "2019": 1164, "2020": 1646, "2021": 555, "2022": 638}, "Circle": {"1973": 26, "1974": 37, "1975": 44, "1976": 25, "1977": 32, "1978": 1, "1979": 1, "1980": 12, "1981": 14, "1982": 17, "1983": 15, "1984": 28, "1985": 24, "1986": 15, "1987": 13, "1988": 31, "1989": 17, "1990": 18, "1991": 25, "1992": 25, "1993": 26, "1994": 30, "1995": 45, "1996": 35, "1997": 6, "1998": 132, "1999": 216, "2000": 235, "2001": 232, "2002": 242, "2003": 313, "2004": 307, "2005": 318, "2006": 313, "2007": 406, "2008": 386, "2009": 416, "2010": 416, "2011": 540, "2012": 890, "2013": 935, "2014": 1097, "2015": 818, "2016": 714, "2017": 655, "2018": 378, "2019": 710, "2020": 843, "2021": 345, "2022": 549}, "Fireball": {"1973": 6, "1974": 12, "1975": 11, "1976": 9, "1977": 4, "1978": 10, "1979": 8, "1980": 5, "1981": 7, "1982": 4, "1983": 6, "1984": 8, "1985": 2, "1986": 5, "1987": 8, "1988": 6, "1989": 5, "1990": 13, "1991": 3, "1992": 11, "1993": 9, "1994": 22, "1995": 1, "1996": 22, "1997": 48, "1998": 1, "1999": 296, "2000": 207, "2001": 186, "2002": 167, "2003": 181, "2004": 185, "2005": 199, "2006": 205, "2007": 208, "2008": 250, "2009": 214, "2010": 337, "2011": 542, "2012": 1018, "2013": 960, "2014": 915, "2015": 598, "2016": 447, "2017": 279, "2018": 151, "2019": 238, "2020": 218, "2021": 118, "2022": 104}, "Triangle": {"1973": 19, "1974": 22, "1975": 28, "1976": 26, "1977": 37, "1978": 35, "1979": 34, "1980": 25, "1981": 17, "1982": 22, "1983": 27, "1984": 26, "1985": 35, "1986": 39, "1987": 25, "1988": 28, "1989": 47, "1990": 38, "1991": 1, "1992": 39, "1993": 62, "1994": 84, "1995": 2, "1996": 101, "1997": 15, "1998": 200, "1999": 277, "2000": 301, "2001": 320, "2002": 299, "2003": 357, "2004": 423, "2005": 411, "2006": 355, "2007": 441, "2008": 496, "2009": 408, "2010": 422, "2011": 521, "2012": 620, "2013": 569, "2014": 657, "2015": 558, "2016": 520, "2017": 360, "2018": 252, "2019": 481, "2020": 411, "2021": 212, "2022": 264}, "Sphere": {"1973": 18, "1974": 17, "1975": 21, "1976": 14, "1977": 18, "1978": 25, "1979": 11, "1980": 25, "1981": 13, "1982": 13, "1983": 15, "1984": 11, "1985": 20, "1986": 18, "1987": 16, "1988": 22, "1989": 31, "1990": 20, "1991": 13, "1992": 17, "1993": 23, "1994": 30, "1995": 33, "1996": 34, "1997": 7, "1998": 144, "1999": 169, "2000": 125, "2001": 169, "2002": 167, "2003": 206, "2004": 252, "2005": 220, "2006": 214, "2007": 241, "2008": 286, "2009": 290, "2010": 302, "2011": 382, "2012": 586, "2013": 555, "2014": 626, "2015": 427, "2016": 337, "2017": 359, "2018": 222, "2019": 314, "2020": 417, "2021": 195, "2022": 240}, "Unknown": {"1973": 14, "1974": 17, "1975": 18, "1976": 18, "1977": 15, "1978": 24, "1979": 17, "1980": 17, "1981": 15, "1982": 12, "1983": 13, "1984": 15, "1985": 14, "1986": 11, "1987": 16, "1988": 20, "1989": 24, "1990": 24, "1991": 15, "1992": 20, "1993": 10, "1994": 34, "1995": 45, "1996": 23, "1997": 1, "1998": 1, "1999": 178, "2000": 193, "2001": 201, "2002": 232, "2003": 287, "2004": 313, "2005": 318, "2006": 260, "2007": 276, "2008": 308, "2009": 307, "2010": 316, "2011": 326, "2012": 383, "2013": 383, "2014": 465, "2015": 419, "2016": 342, "2017": 303, "2018": 223, "2019": 380, "2020": 339, "2021": 160, "2022": 224}, "Formation": {"1973": 4, "1974": 1, "1975": 5, "1976": 5, "1977": 5, "1978": 7, "1979": 6, "1980": 3, "1981": 4, "1982": 4, "1983": 1, "1984": 5, "1985": 9, "1986": 5, "1987": 8, "1988": 4, "1989": 10, "1990": 6, "1991": 2, "1992": 10, "1993": 10, "1994": 4, "1995": 12, "1996": 19, "1997": 70, "1998": 50, "1999": 80, "2000": 74, "2001": 107, "2002": 82, "2003": 110, "2004": 133, "2005": 115, "2006": 105, "2007": 117, "2008": 154, "2009": 129, "2010": 102, "2011": 166, "2012": 219, "2013": 277, "2014": 304, "2015": 216, "2016": 209, "2017": 186, "2018": 95, "2019": 252, "2020": 369, "2021": 166, "2022": 105}, "Oval": {"1973": 27, "1974": 20, "1975": 21, "1976": 24, "1977": 22, "1978": 28, "1979": 10, "1980": 16, "1981": 9, "1982": 10, "1983": 15, "1984": 9, "1985": 1, "1986": 10, "1987": 11, "1988": 17, "1989": 11, "1990": 14, "1991": 10, "1992": 16, "1993": 15, "1994": 20, "1995": 30, "1996": 20, "1997": 1, "1998": 72, "1999": 98, "2000": 118, "2001": 142, "2002": 127, "2003": 186, "2004": 169, "2005": 154, "2006": 172, "2007": 210, "2008": 253, "2009": 205, "2010": 194, "2011": 254, "2012": 347, "2013": 282, "2014": 309, "2015": 248, "2016": 203, "2017": 210, "2018": 109, "2019": 210, "2020": 234, "2021": 122, "2022": 147}, "Disk": {"1973": 72, "1974": 71, "1975": 85, "1976": 82, "1977": 68, "1978": 88, "1979": 51, "1980": 56, "1981": 27, "1982": 44, "1983": 38, "1984": 19, "1985": 31, "1986": 25, "1987": 28, "1988": 26, "1989": 37, "1990": 26, "1991": 36, "1992": 32, "1993": 24, "1994": 59, "1995": 55, "1996": 56, "1997": 98, "1998": 121, "1999": 176, "2000": 181, "2001": 193, "2002": 210, "2003": 240, "2004": 276, "2005": 243, "2006": 219, "2007": 252, "2008": 291, "2009": 202, "2010": 222, "2011": 209, "2012": 243, "2013": 219, "2014": 276, "2015": 214, "2016": 219, "2017": 192, "2018": 130, "2019": 226, "2020": 242, "2021": 121, "2022": 168}, "Changing": {"1973": 2, "1974": 3, "1975": 3, "1976": 6, "1977": 2, "1978": 3, "1979": 4, "1980": 6, "1981": 4, "1982": 6, "1983": 3, "1984": 2, "1985": 5, "1986": 2, "1987": 5, "1988": 6, "1989": 7, "1990": 4, "1991": 4, "1992": 4, "1993": 6, "1994": 1, "1995": 16, "1996": 17, "1997": 16, "1998": 46, "1999": 74, "2000": 69, "2001": 81, "2002": 93, "2003": 96, "2004": 120, "2005": 122, "2006": 111, "2007": 99, "2008": 146, "2009": 109, "2010": 122, "2011": 110, "2012": 178, "2013": 148, "2014": 187, "2015": 169, "2016": 126, "2017": 129, "2018": 113, "2019": 126, "2020": 180, "2021": 122, "2022": 245}, "Cigar": {"1973": 19, "1974": 18, "1975": 22, "1976": 14, "1977": 22, "1978": 12, "1979": 16, "1980": 17, "1981": 13, "1982": 8, "1983": 2, "1984": 7, "1985": 9, "1986": 8, "1987": 12, "1988": 6, "1989": 7, "1990": 8, "1991": 9, "1992": 12, "1993": 12, "1994": 9, "1995": 16, "1996": 1, "1997": 2, "1998": 38, "1999": 85, "2000": 69, "2001": 87, "2002": 75, "2003": 96, "2004": 87, "2005": 109, "2006": 97, "2007": 128, "2008": 135, "2009": 102, "2010": 94, "2011": 85, "2012": 112, "2013": 108, "2014": 127, "2015": 123, "2016": 100, "2017": 100, "2018": 94, "2019": 169, "2020": 138, "2021": 116, "2022": 165}, "Flash": {"1974": 1, "1975": 2, "1976": 3, "1977": 1, "1978": 5, "1979": 1, "1980": 1, "1981": 2, "1982": 1, "1983": 2, "1987": 4, "1988": 1, "1989": 1, "1990": 4, "1991": 1, "1992": 4, "1993": 2, "1994": 8, "1995": 5, "1996": 5, "1997": 1, "1998": 36, "1999": 53, "2000": 39, "2001": 42, "2002": 60, "2003": 63, "2004": 62, "2005": 84, "2006": 68, "2007": 67, "2008": 91, "2009": 86, "2010": 73, "2011": 99, "2012": 135, "2013": 136, "2014": 136, "2015": 142, "2016": 135, "2017": 127, "2018": 76, "2019": 122, "2020": 79, "2021": 35}, "Rectangle": {"1973": 3, "1974": 7, "1975": 4, "1976": 11, "1977": 5, "1978": 14, "1979": 1, "1980": 1, "1981": 9, "1982": 8, "1983": 2, "1984": 5, "1985": 9, "1986": 8, "1987": 10, "1988": 8, "1989": 11, "1990": 6, "1991": 7, "1992": 8, "1993": 10, "1994": 12, "1995": 6, "1996": 15, "1997": 1, "1998": 1, "1999": 35, "2000": 43, "2001": 58, "2002": 46, "2003": 49, "2004": 46, "2005": 57, "2006": 72, "2007": 80, "2008": 86, "2009": 78, "2010": 64, "2011": 81, "2012": 128, "2013": 99, "2014": 131, "2015": 125, "2016": 107, "2017": 84, "2018": 77, "2019": 113, "2020": 107, "2021": 75, "2022": 93}, "Cylinder": {"1973": 6, "1974": 3, "1975": 3, "1976": 1, "1977": 3, "1978": 6, "1979": 5, "1980": 7, "1981": 6, "1982": 4, "1983": 3, "1984": 5, "1985": 4, "1986": 3, "1987": 3, "1988": 7, "1989": 5, "1990": 2, "1991": 4, "1992": 4, "1993": 5, "1994": 3, "1995": 5, "1996": 13, "1997": 4, "1998": 35, "1999": 50, "2000": 49, "2001": 42, "2002": 59, "2003": 68, "2004": 60, "2005": 60, "2006": 58, "2007": 70, "2008": 79, "2009": 61, "2010": 64, "2011": 73, "2012": 108, "2013": 107, "2014": 121, "2015": 82, "2016": 77, "2017": 84, "2018": 62, "2019": 104, "2020": 80, "2021": 83, "2022": 126}, "Diamond": {"1973": 3, "1974": 2, "1976": 3, "1977": 3, "1978": 3, "1979": 1, "1980": 6, "1981": 5, "1982": 3, "1983": 6, "1984": 3, "1985": 5, "1986": 6, "1987": 2, "1988": 4, "1989": 4, "1990": 2, "1991": 3, "1992": 3, "1993": 8, "1994": 2, "1995": 7, "1996": 1, "1997": 1, "1998": 25, "1999": 38, "2000": 47, "2001": 66, "2002": 49, "2003": 51, "2004": 57, "2005": 56, "2006": 48, "2007": 58, "2008": 76, "2009": 52, "2010": 58, "2011": 83, "2012": 104, "2013": 98, "2014": 120, "2015": 100, "2016": 71, "2017": 92, "2018": 57, "2019": 77, "2020": 74, "2021": 36, "2022": 51}, "Chevron": {"1973": 2, "1974": 3, "1975": 3, "1976": 1, "1977": 10, "1978": 5, "1979": 4, "1980": 2, "1981": 5, "1982": 6, "1983": 3, "1984": 3, "1985": 5, "1986": 5, "1987": 8, "1988": 6, "1989": 6, "1990": 2, "1991": 1, "1992": 3, "1993": 4, "1994": 9, "1995": 9, "1996": 5, "1997": 29, "1998": 18, "1999": 51, "2000": 35, "2001": 48, "2002": 62, "2003": 51, "2004": 53, "2005": 43, "2006": 39, "2007": 44, "2008": 66, "2009": 36, "2010": 51, "2011": 42, "2012": 75, "2013": 56, "2014": 85, "2015": 85, "2016": 73, "2017": 70, "2018": 43, "2019": 60, "2020": 55, "2021": 31, "2022": 47}, "Teardrop": {"1974": 1, "1975": 3, "1976": 2, "1978": 1, "1979": 1, "1980": 1, "1982": 2, "1983": 1, "1984": 1, "1985": 1, "1987": 2, "1989": 2, "1990": 2, "1991": 3, "1992": 1, "1993": 6, "1994": 2, "1995": 6, "1996": 6, "1997": 7, "1998": 13, "1999": 30, "2000": 23, "2001": 29, "2002": 38, "2003": 45, "2004": 37, "2005": 34, "2006": 34, "2007": 50, "2008": 53, "2009": 43, "2010": 47, "2011": 50, "2012": 70, "2013": 42, "2014": 59, "2015": 57, "2016": 52, "2017": 40, "2018": 18, "2019": 39, "2020": 50, "2021": 20, "2022": 24}, "Star": {"1995": 1, "2012": 1, "2013": 1, "2016": 1, "2018": 1, "2021": 4, "2022": 69}, "Egg": {"1973": 2, "1974": 2, "1975": 3, "1976": 2, "1977": 3, "1978": 3, "1979": 3, "1980": 4, "1981": 1, "1982": 2, "1983": 1, "1984": 4, "1985": 4, "1986": 1, "1987": 3, "1988": 4, "1989": 5, "1990": 2, "1991": 7, "1992": 6, "1993": 4, "1994": 8, "1995": 2, "1996": 5, "1997": 1, "1998": 21, "1999": 36, "2000": 45, "2001": 39, "2002": 46, "2003": 39, "2004": 50, "2005": 36, "2006": 34, "2007": 25, "2008": 51, "2009": 36, "2010": 22, "2011": 34, "2012": 49, "2013": 46, "2014": 58, "2015": 31, "2016": 33, "2017": 35, "2018": 21, "2019": 51, "2020": 39, "2021": 16, "2022": 31}, "Cone": {"1973": 1, "1974": 1, "1975": 3, "1976": 1, "1977": 1, "1978": 2, "1981": 1, "1984": 1, "1986": 1, "1987": 1, "1988": 3, "1989": 2, "1992": 1, "1995": 5, "1996": 3, "1997": 1, "1998": 12, "1999": 9, "2000": 15, "2001": 20, "2002": 15, "2003": 15, "2004": 12, "2005": 14, "2006": 15, "2007": 18, "2008": 16, "2009": 28, "2010": 16, "2011": 14, "2012": 27, "2013": 29, "2014": 23, "2015": 36, "2016": 24, "2017": 21, "2018": 11, "2019": 17, "2020": 13, "2021": 8, "2022": 23}, "Cross": {"1974": 1, "1976": 1, "1979": 1, "1983": 1, "1988": 2, "1990": 1, "1992": 1, "1993": 1, "1995": 2, "1996": 3, "1997": 3, "1998": 5, "1999": 3, "2000": 10, "2001": 8, "2002": 11, "2003": 15, "2004": 13, "2005": 9, "2006": 9, "2007": 8, "2008": 15, "2009": 15, "2010": 17, "2011": 15, "2012": 22, "2013": 32, "2014": 26, "2015": 18, "2016": 24, "2017": 18, "2018": 16, "2019": 26, "2020": 30, "2021": 7, "2022": 25}, "Delta": {"1974": 1, "1993": 1, "1994": 1, "1995": 1, "1997": 1, "2010": 1, "2021": 4, "2022": 20}}


  chart = Highcharts.chart('interactive', {
    chart: {
      animation: {
        duration: 500
      },
      marginRight: 50,
      height:800,
      width:700
    },
    title: {
      text: 'UFO Shapes per Year',
      align: 'center'
    },
    subtitle: {
      useHTML: true,
      text: getSubtitle(),
      floating: true,
      align: 'right',
      verticalAlign: 'middle',
      y: -20,
      x: -100
    },

    legend: {
      enabled: false
    },
    xAxis: {
      type: 'category'
    },
    yAxis: {
      opposite: true,
      tickPixelInterval: 150,
      title: {
        text: null
      }
    },
    plotOptions: {
      series: {
        animation: false,
        groupPadding: 0,
        pointPadding: 0.1,
        borderWidth: 0,
        colorByPoint: true,
        dataSorting: {
          enabled: true,
          matchByName: true
        },
        type: 'bar',
        dataLabels: {
          enabled: true
        }
      }
    },
    series: [
      {
        type: 'bar',
        name: startYear,
        data: getData(startYear)[1]
      }
    ],
    responsive: {
      rules: [{
        condition: {
          maxWidth: 550
        },
        chartOptions: {
          xAxis: {
            visible: false
          },
          subtitle: {
            x: 0
          },
          plotOptions: {
            series: {
              dataLabels: [{
                enabled: true,
                y: 8
              }, {
                enabled: true,
                format: '{point.name}',
                y: -8,
                style: {
                  fontWeight: 'normal',
                  opacity: 0.7
                }
              }]
            }
          }
        }
      }]
    }
  });
})();

/*
 * Pause the timeline, either when the range is ended, or when clicking the pause button.
 * Pausing stops the timer and resets the button to play mode.
 */
function pause(button) {
  button.title = 'play';
  button.className = 'fa fa-play';
  clearTimeout(chart.sequenceTimer);
  chart.sequenceTimer = undefined;
}

/*
 * Update the chart. This happens either on updating (moving) the range input,
 * or from a timer when the timeline is playing.
 */
function update(increment) {
  if (increment) {
    input.value = parseInt(input.value, 10) + increment;
  }
  if (input.value >= endYear) {
    // Auto-pause
    pause(btn);
  }

  chart.update(
    {
      subtitle: {
        text: getSubtitle()
      }
    },
    false,
    false,
    false
  );

  chart.series[0].update({
    name: input.value,
    data: getData(input.value)[1]
  });
}

/*
 * Play the timeline.
 */
function play(button) {
  button.title = 'pause';
  button.className = 'fa fa-pause';
  chart.sequenceTimer = setInterval(function () {
    update(1);
  }, 750);
}

btn.addEventListener('click', function () {
  if (chart.sequenceTimer) {
    pause(this);
  } else {
    play(this);
  }
});
/*
 * Trigger the update on the range bar click.
 */
input.addEventListener('click', function () {
  update();
});